# Claude Code Provider Balancer - Test Configuration
# 专用于测试的配置文件，使用 mock providers

providers:
  # 测试用的SSE错误提供者 - 专门用于测试重复请求处理
  - name: "Test SSE Error Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic-sse-error"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  # 测试用的成功提供者 - 使用独立测试mock provider
  - name: "Test Success Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  # 测试用的错误提供者
  - name: "Test Error Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  # 测试用的 OpenAI 提供者
  - name: "Test OpenAI Provider"
    type: "openai"
    base_url: "http://localhost:8998/test-providers/openai"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  # Unhealthy计数测试专用providers
  - name: "Test Single Error Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic-unhealthy-test-single"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  - name: "Test Multiple Error Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic-unhealthy-test-multiple"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  - name: "Test Error Reset Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic-unhealthy-test-reset"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

  - name: "Test Always Fail Provider"
    type: "anthropic"
    base_url: "http://localhost:8998/test-providers/anthropic-unhealthy-test-always-fail"
    auth_type: "api_key"
    auth_value: "test-key"
    enabled: true

# 测试用的模型路由配置
model_routes:
  # Claude 模型路由 - 用于测试 sonnet/haiku/opus
  "*claude*":
    - provider: "Test SSE Error Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2
    - provider: "Test Error Provider"
      model: "passthrough"
      priority: 3

  "*sonnet*":
    - provider: "Test SSE Error Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2
    - provider: "Test Error Provider"
      model: "passthrough"
      priority: 3

  "*haiku*":
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Error Provider"
      model: "passthrough"
      priority: 2

  "*opus*":
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Error Provider"
      model: "passthrough"
      priority: 2

  # OpenAI 模型路由
  "*gpt*":
    - provider: "Test OpenAI Provider"
      model: "passthrough"
      priority: 1

  # 测试专用路由
  "*test*":
    - provider: "Test Success Provider"
      model: "success"
      priority: 1

  # Unhealthy计数测试专用路由
  "*unhealthy-single*":
    - provider: "Test Single Error Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2

  "*unhealthy-multiple*":
    - provider: "Test Multiple Error Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2

  "*unhealthy-reset*":
    - provider: "Test Error Reset Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2

  "*unhealthy-always-fail*":
    - provider: "Test Always Fail Provider"
      model: "passthrough"
      priority: 1
    - provider: "Test Success Provider"
      model: "passthrough"
      priority: 2

# 测试用的全局设置
settings:
  # 模型选择策略
  selection_strategy: "priority"

  # 超时配置 - 测试用较短超时
  timeouts:
    non_streaming:
      connect_timeout: 10
      read_timeout: 30
      pool_timeout: 10
    streaming:
      connect_timeout: 10
      read_timeout: 30
      pool_timeout: 10
    caching:
      deduplication_timeout: 60

  # 故障恢复设置 - 测试用较短时间
  sticky_provider_duration: 30
  failure_cooldown: 30

  # Provider健康状态配置 - 测试用
  unhealthy_threshold: 2  # 2次错误才标记unhealthy
  unhealthy_reset_on_success: true
  unhealthy_reset_timeout: 60  # 1分钟超时重置

  # 分离的错误检测配置
  # Exception错误模式 - 使用简单字符串匹配（宽松策略）
  unhealthy_exception_patterns:
    # === 网络相关错误 ===
    - "connection"              # 连接相关错误 (connection failed, connection timeout等)
    - "timeout"                 # 超时错误 (read timeout, connect timeout等)
    - "ssl"                     # SSL/TLS错误
    - "network"                 # 网络错误

  # 响应体错误模式 - 使用正则表达式匹配（严格策略）
  unhealthy_response_body_patterns:
    # === JSON错误字段模式 ===
    - '"error"\s*:\s*".*insufficient.*credits"'    # JSON中的余额不足错误
    - '"error_type"\s*:\s*"quota_exceeded"'         # 配额超限错误
    - '"message"\s*:\s*".*rate.?limit.*"'           # 速率限制错误
    - '"detail"\s*:\s*".*没有可用.*"'                # 中文服务商错误
    
    # === 流式响应错误模式 ===
    - 'data:\s*\{"error"'                           # SSE流中的错误消息
    - 'event:\s*error'                              # SSE错误事件
    
  # HTTP状态码映射到unhealthy判断
  unhealthy_http_codes:
    - 402  # Payment Required
    - 403  # Forbidden
    - 404  # Not Found
    - 408  # Request Timeout
    - 500  # Internal Server Error
    - 502  # Bad Gateway
    - 503  # Service Unavailable
    - 504  # Gateway Timeout
    - 429  # Too Many Requests
    - 520  # Unknown Error (Cloudflare)
    - 521  # Web Server Is Down
    - 522  # Connection Timed Out
    - 523  # Origin Is Unreachable
    - 524  # A Timeout Occurred

  # 日志设置
  log_level: "DEBUG"
  log_color: true
  log_file_path: "logs/test-logs.jsonl"

  # 服务器配置 - 测试用独立端口
  host: "127.0.0.1"
  port: 8999

  # 应用信息
  app_name: "ClaudeCode Providers Balancer - Test Mode"
  app_version: "0.1.1-test"

  # OAuth配置 - 测试用禁用
  oauth:
    enable_persistence: false
    enable_auto_refresh: false

  # 请求去重设置
  deduplication:
    enabled: true
    include_max_tokens_in_signature: false
    sse_error_cleanup_delay: 3

  # 测试设置 - 禁用延迟
  testing:
    simulate_delay: false
    delay_seconds: 0